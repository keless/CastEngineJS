"use strict"; //ES6
(function(){var _global=this;var _rng;if(typeof _global.require=="function")try{var _rb=_global.require("crypto").randomBytes;_rng=_rb&&function(){return _rb(16)}}catch(e){}if(!_rng&&_global.crypto&&crypto.getRandomValues){var _rnds8=new Uint8Array(16);_rng=function whatwgRNG(){crypto.getRandomValues(_rnds8);return _rnds8}}if(!_rng){var _rnds=new Array(16);_rng=function(){for(var i=0,r;i<16;i++){if((i&3)===0)r=Math.random()*4294967296;_rnds[i]=r>>>((i&3)<<3)&255}return _rnds}}var BufferClass=typeof _global.Buffer==
"function"?_global.Buffer:Array;var _byteToHex=[];var _hexToByte={};for(var i=0;i<256;i++){_byteToHex[i]=(i+256).toString(16).substr(1);_hexToByte[_byteToHex[i]]=i}function parse(s,buf,offset){var i=buf&&offset||0,ii=0;buf=buf||[];s.toLowerCase().replace(/[0-9a-f]{2}/g,function(oct){if(ii<16)buf[i+ii++]=_hexToByte[oct]});while(ii<16)buf[i+ii++]=0;return buf}function unparse(buf,offset){var i=offset||0,bth=_byteToHex;return bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+
bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]}var _seedBytes=_rng();var _nodeId=[_seedBytes[0]|1,_seedBytes[1],_seedBytes[2],_seedBytes[3],_seedBytes[4],_seedBytes[5]];var _clockseq=(_seedBytes[6]<<8|_seedBytes[7])&16383;var _lastMSecs=0,_lastNSecs=0;function v1(options,buf,offset){var i=buf&&offset||0;var b=buf||[];options=options||{};var clockseq=options.clockseq!=null?options.clockseq:
_clockseq;var msecs=options.msecs!=null?options.msecs:(new Date).getTime();var nsecs=options.nsecs!=null?options.nsecs:_lastNSecs+1;var dt=msecs-_lastMSecs+(nsecs-_lastNSecs)/1E4;if(dt<0&&options.clockseq==null)clockseq=clockseq+1&16383;if((dt<0||msecs>_lastMSecs)&&options.nsecs==null)nsecs=0;if(nsecs>=1E4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");_lastMSecs=msecs;_lastNSecs=nsecs;_clockseq=clockseq;msecs+=122192928E5;var tl=((msecs&268435455)*1E4+nsecs)%4294967296;b[i++]=
tl>>>24&255;b[i++]=tl>>>16&255;b[i++]=tl>>>8&255;b[i++]=tl&255;var tmh=msecs/4294967296*1E4&268435455;b[i++]=tmh>>>8&255;b[i++]=tmh&255;b[i++]=tmh>>>24&15|16;b[i++]=tmh>>>16&255;b[i++]=clockseq>>>8|128;b[i++]=clockseq&255;var node=options.node||_nodeId;for(var n=0;n<6;n++)b[i+n]=node[n];return buf?buf:unparse(b)}function v4(options,buf,offset){var i=buf&&offset||0;if(typeof options=="string"){buf=options=="binary"?new BufferClass(16):null;options=null}options=options||{};var rnds=options.random||
(options.rng||_rng)();rnds[6]=rnds[6]&15|64;rnds[8]=rnds[8]&63|128;if(buf)for(var ii=0;ii<16;ii++)buf[i+ii]=rnds[ii];return buf||unparse(rnds)}var uuid=v4;uuid.v1=v1;uuid.v4=v4;uuid.parse=parse;uuid.unparse=unparse;uuid.BufferClass=BufferClass;if(typeof define==="function"&&define.amd)define(function(){return uuid});else if(typeof module!="undefined"&&module.exports)module.exports=uuid;else{var _previousRoot=_global.uuid;uuid.noConflict=function(){_global.uuid=_previousRoot;return uuid};_global.uuid=
uuid}}).call(this);(function(){var inputs=[];var CanvasInput=window.CanvasInput=function(o){var self=this;o=o?o:{};self._canvas=o.canvas||null;self._ctx=self._canvas?self._canvas.getContext("2d"):null;self._x=o.x||0;self._y=o.y||0;self._extraX=o.extraX||0;self._extraY=o.extraY||0;self._fontSize=o.fontSize||14;self._fontFamily=o.fontFamily||"Arial";self._fontColor=o.fontColor||"#000";self._placeHolderColor=o.placeHolderColor||"#bfbebd";self._fontWeight=o.fontWeight||"normal";self._fontStyle=o.fontStyle||"normal";self._fontShadowColor=
o.fontShadowColor||"";self._fontShadowBlur=o.fontShadowBlur||0;self._fontShadowOffsetX=o.fontShadowOffsetX||0;self._fontShadowOffsetY=o.fontShadowOffsetY||0;self._readonly=o.readonly||false;self._maxlength=o.maxlength||null;self._width=o.width||150;self._height=o.height||self._fontSize;self._padding=o.padding>=0?o.padding:5;self._borderWidth=o.borderWidth>=0?o.borderWidth:1;self._borderColor=o.borderColor||"#959595";self._borderRadius=o.borderRadius>=0?o.borderRadius:3;self._backgroundImage=o.backgroundImage||
"";self._boxShadow=o.boxShadow||"1px 1px 0px rgba(255, 255, 255, 1)";self._innerShadow=o.innerShadow||"0px 0px 4px rgba(0, 0, 0, 0.4)";self._selectionColor=o.selectionColor||"rgba(179, 212, 253, 0.8)";self._placeHolder=o.placeHolder||"";self._value=(o.value||self._placeHolder)+"";self._onsubmit=o.onsubmit||function(){};self._onkeydown=o.onkeydown||function(){};self._onkeyup=o.onkeyup||function(){};self._onfocus=o.onfocus||function(){};self._onblur=o.onblur||function(){};self._cursor=false;self._cursorPos=
0;self._hasFocus=false;self._selection=[0,0];self._wasOver=false;self.boxShadow(self._boxShadow,true);self._calcWH();self._renderCanvas=document.createElement("canvas");self._renderCanvas.setAttribute("width",self.outerW);self._renderCanvas.setAttribute("height",self.outerH);self._renderCtx=self._renderCanvas.getContext("2d");self._shadowCanvas=document.createElement("canvas");self._shadowCanvas.setAttribute("width",self._width+self._padding*2);self._shadowCanvas.setAttribute("height",self._height+
self._padding*2);self._shadowCtx=self._shadowCanvas.getContext("2d");if(typeof o.backgroundGradient!=="undefined"){self._backgroundColor=self._renderCtx.createLinearGradient(0,0,0,self.outerH);self._backgroundColor.addColorStop(0,o.backgroundGradient[0]);self._backgroundColor.addColorStop(1,o.backgroundGradient[1])}else self._backgroundColor=o.backgroundColor||"#fff";if(self._canvas){self._canvas.addEventListener("mousemove",function(e){e=e||window.event;self.mousemove(e,self)},false);self._canvas.addEventListener("mousedown",
function(e){e=e||window.event;self.mousedown(e,self)},false);self._canvas.addEventListener("mouseup",function(e){e=e||window.event;self.mouseup(e,self)},false)}window.addEventListener("mouseup",function(e){e=e||window.event;if(self._hasFocus&&!self._mouseDown)self.blur()},true);self._hiddenInput=document.createElement("input");self._hiddenInput.type="text";self._hiddenInput.style.position="absolute";self._hiddenInput.style.opacity=0;self._hiddenInput.style.pointerEvents="none";self._hiddenInput.style.left=
self._x+self._extraX+(self._canvas?self._canvas.offsetLeft:0)+"px";self._hiddenInput.style.top=self._y+self._extraY+(self._canvas?self._canvas.offsetTop:0)+"px";self._hiddenInput.style.width=self._width+"px";self._hiddenInput.style.height=self._height+"px";self._hiddenInput.style.zIndex=0;if(self._maxlength)self._hiddenInput.maxLength=self._maxlength;document.body.appendChild(self._hiddenInput);self._hiddenInput.value=self._value;self._hiddenInput.addEventListener("keydown",function(e){e=e||window.event;
if(self._hasFocus)self.keydown(e,self)});self._hiddenInput.addEventListener("keyup",function(e){e=e||window.event;self._value=self._hiddenInput.value;self._cursorPos=self._hiddenInput.selectionStart;self._selection=[self._hiddenInput.selectionStart,self._hiddenInput.selectionEnd];self.render();if(self._hasFocus)self._onkeyup(e,self)});inputs.push(self);self._inputsIndex=inputs.length-1;self.render()};CanvasInput.prototype={canvas:function(data){var self=this;if(typeof data!=="undefined"){self._canvas=
data;self._ctx=self._canvas.getContext("2d");return self.render()}else return self._canvas},x:function(data){var self=this;if(typeof data!=="undefined"){self._x=data;return self.render()}else return self._x},y:function(data){var self=this;if(typeof data!=="undefined"){self._y=data;return self.render()}else return self._y},extraX:function(data){var self=this;if(typeof data!=="undefined"){self._extraX=data;return self.render()}else return self._extraX},extraY:function(data){var self=this;if(typeof data!==
"undefined"){self._extraY=data;return self.render()}else return self._extraY},fontSize:function(data){var self=this;if(typeof data!=="undefined"){self._fontSize=data;return self.render()}else return self._fontSize},fontFamily:function(data){var self=this;if(typeof data!=="undefined"){self._fontFamily=data;return self.render()}else return self._fontFamily},fontColor:function(data){var self=this;if(typeof data!=="undefined"){self._fontColor=data;return self.render()}else return self._fontColor},placeHolderColor:function(data){var self=
this;if(typeof data!=="undefined"){self._placeHolderColor=data;return self.render()}else return self._placeHolderColor},fontWeight:function(data){var self=this;if(typeof data!=="undefined"){self._fontWeight=data;return self.render()}else return self._fontWeight},fontStyle:function(data){var self=this;if(typeof data!=="undefined"){self._fontStyle=data;return self.render()}else return self._fontStyle},fontShadowColor:function(data){var self=this;if(typeof data!=="undefined"){self._fontShadowColor=data;
return self.render()}else return self._fontShadowColor},fontShadowBlur:function(data){var self=this;if(typeof data!=="undefined"){self._fontShadowBlur=data;return self.render()}else return self._fontShadowBlur},fontShadowOffsetX:function(data){var self=this;if(typeof data!=="undefined"){self._fontShadowOffsetX=data;return self.render()}else return self._fontShadowOffsetX},fontShadowOffsetY:function(data){var self=this;if(typeof data!=="undefined"){self._fontShadowOffsetY=data;return self.render()}else return self._fontShadowOffsetY},
width:function(data){var self=this;if(typeof data!=="undefined"){self._width=data;self._calcWH();self._updateCanvasWH();return self.render()}else return self._width},height:function(data){var self=this;if(typeof data!=="undefined"){self._height=data;self._calcWH();self._updateCanvasWH();return self.render()}else return self._height},padding:function(data){var self=this;if(typeof data!=="undefined"){self._padding=data;self._calcWH();self._updateCanvasWH();return self.render()}else return self._padding},
borderWidth:function(data){var self=this;if(typeof data!=="undefined"){self._borderWidth=data;self._calcWH();self._updateCanvasWH();return self.render()}else return self._borderWidth},borderColor:function(data){var self=this;if(typeof data!=="undefined"){self._borderColor=data;return self.render()}else return self._borderColor},borderRadius:function(data){var self=this;if(typeof data!=="undefined"){self._borderRadius=data;return self.render()}else return self._borderRadius},backgroundColor:function(data){var self=
this;if(typeof data!=="undefined"){self._backgroundColor=data;return self.render()}else return self._backgroundColor},backgroundGradient:function(data){var self=this;if(typeof data!=="undefined"){self._backgroundColor=self._renderCtx.createLinearGradient(0,0,0,self.outerH);self._backgroundColor.addColorStop(0,data[0]);self._backgroundColor.addColorStop(1,data[1]);return self.render()}else return self._backgroundColor},boxShadow:function(data,doReturn){var self=this;if(typeof data!=="undefined"){var boxShadow=
data.split("px ");self._boxShadow={x:self._boxShadow==="none"?0:parseInt(boxShadow[0],10),y:self._boxShadow==="none"?0:parseInt(boxShadow[1],10),blur:self._boxShadow==="none"?0:parseInt(boxShadow[2],10),color:self._boxShadow==="none"?"":boxShadow[3]};if(self._boxShadow.x<0){self.shadowL=Math.abs(self._boxShadow.x)+self._boxShadow.blur;self.shadowR=self._boxShadow.blur+self._boxShadow.x}else{self.shadowL=Math.abs(self._boxShadow.blur-self._boxShadow.x);self.shadowR=self._boxShadow.blur+self._boxShadow.x}if(self._boxShadow.y<
0){self.shadowT=Math.abs(self._boxShadow.y)+self._boxShadow.blur;self.shadowB=self._boxShadow.blur+self._boxShadow.y}else{self.shadowT=Math.abs(self._boxShadow.blur-self._boxShadow.y);self.shadowB=self._boxShadow.blur+self._boxShadow.y}self.shadowW=self.shadowL+self.shadowR;self.shadowH=self.shadowT+self.shadowB;self._calcWH();if(!doReturn){self._updateCanvasWH();return self.render()}}else return self._boxShadow},innerShadow:function(data){var self=this;if(typeof data!=="undefined"){self._innerShadow=
data;return self.render()}else return self._innerShadow},selectionColor:function(data){var self=this;if(typeof data!=="undefined"){self._selectionColor=data;return self.render()}else return self._selectionColor},placeHolder:function(data){var self=this;if(typeof data!=="undefined"){self._placeHolder=data;return self.render()}else return self._placeHolder},value:function(data){var self=this;if(typeof data!=="undefined"){self._value=data+"";self._hiddenInput.value=data+"";self._cursorPos=self._clipText().length;
self.render();return self}else return self._value===self._placeHolder?"":self._value},onsubmit:function(fn){var self=this;if(typeof fn!=="undefined"){self._onsubmit=fn;return self}else self._onsubmit()},onkeydown:function(fn){var self=this;if(typeof fn!=="undefined"){self._onkeydown=fn;return self}else self._onkeydown()},onkeyup:function(fn){var self=this;if(typeof fn!=="undefined"){self._onkeyup=fn;return self}else self._onkeyup()},focus:function(pos){var self=this;if(!self._hasFocus){self._onfocus(self);
for(var i=0;i<inputs.length;i++)if(inputs[i]._hasFocus)inputs[i].blur()}if(!self._selectionUpdated)self._selection=[0,0];else delete self._selectionUpdated;self._hasFocus=true;if(self._readonly){self._hiddenInput.readOnly=true;return}else self._hiddenInput.readOnly=false;self._cursorPos=typeof pos==="number"?pos:self._clipText().length;if(self._placeHolder===self._value){self._value="";self._hiddenInput.value=""}self._cursor=true;if(self._cursorInterval)clearInterval(self._cursorInterval);self._cursorInterval=
setInterval(function(){self._cursor=!self._cursor;self.render()},500);var hasSelection=self._selection[0]>0||self._selection[1]>0;self._hiddenInput.focus();self._hiddenInput.selectionStart=hasSelection?self._selection[0]:self._cursorPos;self._hiddenInput.selectionEnd=hasSelection?self._selection[1]:self._cursorPos;return self.render()},blur:function(_this){var self=_this||this;self._onblur(self);if(self._cursorInterval)clearInterval(self._cursorInterval);self._hasFocus=false;self._cursor=false;self._selection=
[0,0];self._hiddenInput.blur();if(self._value==="")self._value=self._placeHolder;return self.render()},keydown:function(e,self){var keyCode=e.which,isShift=e.shiftKey,key=null,startText,endText;if(self._readonly||!self._hasFocus)return;self._onkeydown(e,self);if(keyCode===65&&(e.ctrlKey||e.metaKey)){self.selectText();e.preventDefault();return self.render()}if(keyCode===17||e.metaKey||e.ctrlKey)return self;if(keyCode===13){e.preventDefault();self._onsubmit(e,self)}else if(keyCode===9){e.preventDefault();
if(inputs.length>1){var next=inputs[self._inputsIndex+1]?self._inputsIndex+1:0;self.blur();setTimeout(function(){inputs[next].focus()},10)}}self._value=self._hiddenInput.value;self._cursorPos=self._hiddenInput.selectionStart;self._selection=[0,0];return self.render()},click:function(e,self){var mouse=self._mousePos(e),x=mouse.x,y=mouse.y;if(self._endSelection){delete self._endSelection;delete self._selectionUpdated;return}if(self._canvas&&self._overInput(x,y)||!self._canvas){if(self._mouseDown){self._mouseDown=
false;self.click(e,self);return self.focus(self._clickPos(x,y))}}else return self.blur()},mousemove:function(e,self){var mouse=self._mousePos(e),x=mouse.x,y=mouse.y,isOver=self._overInput(x,y);if(isOver&&self._canvas){self._canvas.style.cursor="text";self._wasOver=true}else if(self._wasOver&&self._canvas){self._canvas.style.cursor="default";self._wasOver=false}if(self._hasFocus&&self._selectionStart>=0){var curPos=self._clickPos(x,y),start=Math.min(self._selectionStart,curPos),end=Math.max(self._selectionStart,
curPos);if(!isOver){self._selectionUpdated=true;self._endSelection=true;delete self._selectionStart;self.render();return}if(self._selection[0]!==start||self._selection[1]!==end){self._selection=[start,end];self.render()}}},mousedown:function(e,self){var mouse=self._mousePos(e),x=mouse.x,y=mouse.y,isOver=self._overInput(x,y);self._mouseDown=isOver;if(self._hasFocus&&isOver)self._selectionStart=self._clickPos(x,y)},mouseup:function(e,self){var mouse=self._mousePos(e),x=mouse.x,y=mouse.y;var isSelection=
self._clickPos(x,y)!==self._selectionStart;if(self._hasFocus&&self._selectionStart>=0&&self._overInput(x,y)&&isSelection){self._selectionUpdated=true;delete self._selectionStart;self.render()}else delete self._selectionStart;self.click(e,self)},selectText:function(range){var self=this,range=range||[0,self._value.length];setTimeout(function(){self._selection=[range[0],range[1]];self._hiddenInput.selectionStart=range[0];self._hiddenInput.selectionEnd=range[1];self.render()},1);return self},renderCanvas:function(){return this._renderCanvas},
render:function(){},renderNow:function(x,y){var self=this,ctx=self._renderCtx,w=self.outerW,h=self.outerH,br=self._borderRadius,bw=self._borderWidth,sw=self.shadowW,sh=self.shadowH;if(!ctx)return;ctx.shadowOffsetX=self._boxShadow.x;ctx.shadowOffsetY=self._boxShadow.y;ctx.shadowBlur=self._boxShadow.blur;ctx.shadowColor=self._boxShadow.color;if(self._borderWidth>0){ctx.fillStyle=self._borderColor;self._roundedRect(ctx,self.shadowL,self.shadowT,w-sw,h-sh,br);ctx.fill();ctx.shadowOffsetX=0;ctx.shadowOffsetY=
0;ctx.shadowBlur=0}self._drawTextBox(function(){ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;ctx.shadowBlur=0;var text=self._clipText();var paddingBorder=self._padding+self._borderWidth+self.shadowT;if(self._selection[1]>0){var selectOffset=self._textWidth(text.substring(0,self._selection[0])),selectWidth=self._textWidth(text.substring(self._selection[0],self._selection[1]));ctx.fillStyle=self._selectionColor;ctx.fillRect(paddingBorder+selectOffset,paddingBorder,selectWidth,self._height)}if(self._cursor){var cursorOffset=
self._textWidth(text.substring(0,self._cursorPos));ctx.fillStyle=self._fontColor;ctx.fillRect(paddingBorder+cursorOffset,paddingBorder,1,self._height)}var textX=self._padding+self._borderWidth+self.shadowL,textY=Math.round(paddingBorder+self._height/2);text=text===""&&self._placeHolder?self._placeHolder:text;ctx.fillStyle=self._value!==""&&self._value!==self._placeHolder?self._fontColor:self._placeHolderColor;ctx.font=self._fontStyle+" "+self._fontWeight+" "+self._fontSize+"px "+self._fontFamily;
ctx.shadowColor=self._fontShadowColor;ctx.shadowBlur=self._fontShadowBlur;ctx.shadowOffsetX=self._fontShadowOffsetX;ctx.shadowOffsetY=self._fontShadowOffsetY;ctx.textAlign="left";ctx.textBaseline="middle";ctx.fillText(text,textX,textY);var innerShadow=self._innerShadow.split("px "),isOffsetX=self._innerShadow==="none"?0:parseInt(innerShadow[0],10),isOffsetY=self._innerShadow==="none"?0:parseInt(innerShadow[1],10),isBlur=self._innerShadow==="none"?0:parseInt(innerShadow[2],10),isColor=self._innerShadow===
"none"?"":innerShadow[3];if(isBlur>0){var shadowCtx=self._shadowCtx,scw=shadowCtx.canvas.width,sch=shadowCtx.canvas.height;shadowCtx.clearRect(0,0,scw,sch);shadowCtx.shadowBlur=isBlur;shadowCtx.shadowColor=isColor;shadowCtx.shadowOffsetX=0;shadowCtx.shadowOffsetY=isOffsetY;shadowCtx.fillRect(-1*w,-100,3*w,100);shadowCtx.shadowOffsetX=isOffsetX;shadowCtx.shadowOffsetY=0;shadowCtx.fillRect(scw,-1*h,100,3*h);shadowCtx.shadowOffsetX=0;shadowCtx.shadowOffsetY=isOffsetY;shadowCtx.fillRect(-1*w,sch,3*w,
100);shadowCtx.shadowOffsetX=isOffsetX;shadowCtx.shadowOffsetY=0;shadowCtx.fillRect(-100,-1*h,100,3*h);self._roundedRect(ctx,bw+self.shadowL,bw+self.shadowT,w-bw*2-sw,h-bw*2-sh,br);ctx.clip();ctx.drawImage(self._shadowCanvas,0,0,scw,sch,bw+self.shadowL,bw+self.shadowT,scw,sch)}if(self._ctx)self._ctx.drawImage(self._renderCanvas,x,y);return self})},destroy:function(){var self=this;var index=inputs.indexOf(self);if(index!=-1)inputs.splice(index,1);if(self._hasFocus)self.blur();document.body.removeChild(self._hiddenInput);
self._renderCanvas=null;self._shadowCanvas=null;self._renderCtx=null},_drawTextBox:function(fn){var self=this,ctx=self._renderCtx,w=self.outerW,h=self.outerH,br=self._borderRadius,bw=self._borderWidth,sw=self.shadowW,sh=self.shadowH;if(self._backgroundImage===""){ctx.fillStyle=self._backgroundColor;self._roundedRect(ctx,bw+self.shadowL,bw+self.shadowT,w-bw*2-sw,h-bw*2-sh,br);ctx.fill();fn()}else{var img=new Image;img.src=self._backgroundImage;img.onload=function(){ctx.drawImage(img,0,0,img.width,
img.height,bw+self.shadowL,bw+self.shadowT,w,h);fn()}}},_clearSelection:function(){var self=this;if(self._selection[1]>0){var start=self._selection[0],end=self._selection[1];self._value=self._value.substr(0,start)+self._value.substr(end);self._cursorPos=start;self._cursorPos=self._cursorPos<0?0:self._cursorPos;self._selection=[0,0];return true}return false},_clipText:function(value){var self=this;value=typeof value==="undefined"?self._value:value;var textWidth=self._textWidth(value),fillPer=textWidth/
(self._width-self._padding),text=fillPer>1?value.substr(-1*Math.floor(value.length/fillPer)):value;return text+""},_textWidth:function(text){var self=this,ctx=self._renderCtx;ctx.font=self._fontStyle+" "+self._fontWeight+" "+self._fontSize+"px "+self._fontFamily;ctx.textAlign="left";return ctx.measureText(text).width},_calcWH:function(){var self=this;self.outerW=self._width+self._padding*2+self._borderWidth*2+self.shadowW;self.outerH=self._height+self._padding*2+self._borderWidth*2+self.shadowH},
_updateCanvasWH:function(){var self=this,oldW=self._renderCanvas.width,oldH=self._renderCanvas.height;self._renderCanvas.setAttribute("width",self.outerW);self._renderCanvas.setAttribute("height",self.outerH);self._shadowCanvas.setAttribute("width",self._width+self._padding*2);self._shadowCanvas.setAttribute("height",self._height+self._padding*2);if(self._ctx);},_roundedRect:function(ctx,x,y,w,h,r){if(w<2*r)r=w/2;if(h<2*r)r=h/2;ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+
w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath()},_overInput:function(x,y){var self=this,xLeft=x>=self.vecPos.x+self._extraX,xRight=x<=self.vecPos.x+self._extraX+self._width+self._padding*2,yTop=y>=self.vecPos.y+self._extraY,yBottom=y<=self.vecPos.y+self._extraY+self._height+self._padding*2;return xLeft&&xRight&&yTop&&yBottom},_clickPos:function(x,y){var self=
this,value=self._value;if(self._value===self._placeHolder)value="";var text=self._clipText(value),totalW=0,pos=text.length;if(x-(self.vecPos.x+self._extraX)<self._textWidth(text))for(var i=0;i<text.length;i++){totalW+=self._textWidth(text[i]);if(totalW>=x-(self.vecPos.x+self._extraX)){pos=i;break}}return pos},_mousePos:function(e){var elm=e.target,style=document.defaultView.getComputedStyle(elm,undefined),paddingLeft=parseInt(style["paddingLeft"],10)||0,paddingTop=parseInt(style["paddingLeft"],10)||
0,borderLeft=parseInt(style["borderLeftWidth"],10)||0,borderTop=parseInt(style["borderLeftWidth"],10)||0,htmlTop=document.body.parentNode.offsetTop||0,htmlLeft=document.body.parentNode.offsetLeft||0,offsetX=0,offsetY=0,x,y;if(typeof elm.offsetParent!=="undefined"){do{offsetX+=elm.offsetLeft;offsetY+=elm.offsetTop}while(elm=elm.offsetParent)}offsetX+=paddingLeft+borderLeft+htmlLeft;offsetY+=paddingTop+borderTop+htmlTop;return{x:e.pageX-offsetX,y:e.pageY-offsetY}}}})();class Service{static Get(serviceName){if(!this.g_services)this.g_services=[];return this.g_services[serviceName]}static Add(serviceName,service){if(!this.g_services)this.g_services=[];if(this.g_services[serviceName])console.warn("Service "+serviceName+" overrided!");this.g_services[serviceName]=service}};class JsonManager{static Get(){return JsonManager.instance}constructor(){this.m_domains={};this.verbose=true}addJsonBlob(json){if(json.constructor==={}.constructor)for(var domain in json){this.m_domains[domain]=json[domain];if(this.verbose)console.log("loaded json domain "+domain)}}addJsonDomain(domainName,json){this.m_domains[domainName]=json}getJson(domain,path){if(this.m_domains.hasOwnProperty(domain))if(!path)return this.m_domains[domain];else{var arr=path.split(".");if(arr.length==1)return this.m_domains[domain][path];
var to=this.m_domains[domain];for(var i=0;i<arr.length;i++)if(to.hasOwnProperty(path))to=to[path];return to}return null}}JsonManager.instance=new JsonManager;class Animation{constructor(){this.events=["end"];this.graph={"idle":{fps:5,transitions:{"end":"idle"}}};this.defaultAnim="";this.sprites={}}LoadFromJson(dataJson){this.events=dataJson.events;this.graph=dataJson.graph;this.defaultAnim=dataJson.defaultState}QuickAttach(baseName,extName,fnOnComplete){var RP=Service.Get("rp");var self=this;var imgsDownloading=0;for(var state in this.graph){imgsDownloading++;console.log("get sprite "+state);(function(stateName){RP.getSprite(baseName+state+extName,function(e){console.log("got sprite for state "+
stateName);var sprite=e.res;if(sprite){self.AttachSprite(stateName,sprite);imgsDownloading--;if(fnOnComplete&&imgsDownloading==0)fnOnComplete()}})})(state)}}AttachSprite(animState,sprite){console.log("attach sprite for "+animState);this.sprites[animState]=sprite}CreateInstance(){return new AnimationInstance(this)}}
class AnimationInstance{constructor(animation){this.pAnimation=animation;this.startTime=0;this.currAnim="null";this.drawFrame=0;this.drawSprite=null;this.startAnim(0,this.pAnimation.defaultAnim)}event(ct,evt){var state=this.pAnimation.graph[this.currAnim];var next=state[evt];if(next){this.startAnim(ct,next);return true}else if(evt!=this.currAnim)console.warn("failed to handle event "+evt);return false}startAnim(ct,animState){animState=animState||this.pAnimation.defaultAnim;this.currAnim=animState;
this.startTime=ct;this.drawFrame=0;this.drawSprite=this.pAnimation.sprites[this.currAnim];if(!this.drawSprite)console.warn("no sprite for startAnim("+animState+")")}Update(ct){var sprite=this.drawSprite;var numFrames=sprite.getNumFrames();var animLengthS=numFrames/sprite.getFPS();var dt=ct-this.startTime;if(dt>animLengthS){var endTime=this.startTime+animLengthS;this.event(endTime,"end");return}else this.drawFrame=Math.floor(dt/animLengthS*numFrames)}Draw(gfx,x,y,hFlip){this.drawSprite.drawFrame(gfx,
x,y,this.drawFrame,hFlip)}getCurrentSprite(){return this.drawSprite}};var KEY_LEFT=37;var KEY_UP=38;var KEY_RIGHT=39;var KEY_DOWN=40;
class Application{constructor(strAppName,strCanvas2DName,fnOnLoad){this.appName=strAppName;this.lastMousePos=new Vec2D;var appSelf=this;var updateLastMousePos=function(e){var canvas=Service.Get("gfx").canvas;var mouseX=e.clientX-(canvas.left||canvas.offsetLeft);var mouseY=e.clientY-(canvas.top||canvas.offsetTop);appSelf.lastMousePos.setVal(mouseX,mouseY)};document.onmousedown=function(e){updateLastMousePos(e);appSelf.OnMouseDown(e,appSelf.lastMousePos.x,appSelf.lastMousePos.y,e.which)};document.onmousemove=
function(e){updateLastMousePos(e)};document.onmouseup=function(e){updateLastMousePos(e)};document.onmouseout=function(e){updateLastMousePos(e)};document.onmousewheel=function(e){var delta=e.wheelDelta;appSelf.OnMouseWheel(e,delta)};this.lastUpdateTick=0;this.elapsedTime=0;Service.Add("app",this);this.instanciateSingletons(strCanvas2DName)}instanciateSingletons(strCanvas2DName){new ResourceProvider;new Graphics(strCanvas2DName);new AudioManager;new Physics;new SaveData;new AppStateController}Play(){this._runUpdateLoop()}Pause(){this._stopUpdateLoop()}IsPaused(){return this.UpdateLoopInterval==
null}_runUpdateLoop(){if(this.UpdateLoopInterval!=null)return;this.lastUpdateTick=(new Date).getTime();this.UpdateLoopInterval=setInterval(this._updateLoop.bind(this),30)}_stopUpdateLoop(){if(this.UpdateLoopInterval==null)return;clearInterval(this.UpdateLoopInterval.bind(this));this.UpdateLoopInterval=null}_updateLoop(){var stateController=Service.Get("state");var state=stateController.currentState;var ct=(new Date).getTime();ct/=1E3;var dt=ct-this.lastUpdateTick;this.lastUpdateTick=ct;this.elapsedTime+=
dt;this.OnUpdateBegin(dt,this.elapsedTime);if(state.model)state.model.Update(ct,dt);var physics=Service.Get("physics");physics.Tick();this.OnUpdateEnd(dt,this.elapsedTime);var gfx=Service.Get("gfx");gfx.begin(true);if(state.view)state.view.Draw(gfx,0,0,this.elapsedTime);this.OnDraw(gfx,dt,this.elapsedTime)}OnLoad(){console.log("override me: Application.onApplicationLoaded()")}OnUpdateBegin(dtSeconds,ctSeconds){}OnUpdateEnd(dtSeconds,ctSeconds){}OnDraw(gfx,dtSeconds,ctSeconds){}OnKeyDown(e){var stateController=
Service.Get("state");var state=stateController.currentState;state.view.OnKeyDown(e,this.lastMousePos.x,this.lastMousePos.y)}OnKeyUp(e){var stateController=Service.Get("state");var state=stateController.currentState;state.view.OnKeyUp(e,this.lastMousePos.x,this.lastMousePos.y)}OnMouseDown(e,mouseX,mouseY){var stateController=Service.Get("state");var state=stateController.currentState;state.view.OnMouseDown(e,mouseX,mouseY)}OnMouseWheel(e,delta){}};class AppState{constructor(){this.view=null;this.model=null}Destroy(){if(this.view&&this.view.Destroy)this.view.Destroy();if(this.model&&this.model.Destroy)this.model.Destroy()}}
class AppStateController{constructor(){this.stateMap={};this.currentState=null;Service.Add("state",this)}addState(stateName,stateClass){this.stateMap[stateName]=stateClass}gotoState(stateName,params){if(!this.stateMap[stateName]){console.error("no state named "+stateName+" available");return}if(this.currentState){this.currentState.Destroy();this.currentState=null}this.currentState=new this.stateMap[stateName](params)}}
class BaseListener{constructor(){this._listeners=[]}Destroy(){this.DestroyListeners()}SetListener(evtName,fn,bus){if(!bus)bus=EventBus.ui;bus.addListener(evtName,fn.bind(this));this._listeners.push({bus:bus,evt:evtName,fn:fn})}DestroyListeners(){for(var l of this._listeners)l.bus.removeListener(l.evt,l.fn)}}class BaseStateModel extends BaseListener{constructor(){super()}Destroy(){super.Destroy()}Update(ct,dt){}}
class BaseStateView extends BaseListener{constructor(){super();this.rootView=new NodeView}Destroy(){super.Destroy()}OnMouseDown(e,x,y){if(this.rootView)this.rootView.OnMouseDown(e,x,y)}OnMouseWheel(e,delta){}OnKeyDown(e,x,y){if(this.rootView)this.rootView.OnKeyDown(e,x,y)}OnKeyUp(e,x,y){if(this.rootView)this.rootView.OnKeyUp(e,x,y)}Draw(g,x,y,ct){if(this.rootView)this.rootView.Draw(g,x,y,ct)}};class AudioManager{constructor(){console.log("AudioManager created");Service.Add("audio",this);EventBus.sfx.addListener("play",AudioManager.onSfxPlay.bind(this))}static onSfxPlay(evt){if(!this.g_sfx)this.g_sfx={};var file=evt.file;if(!this.g_sfx[file])this.g_sfx[file]=new Audio(file);var audio=this.g_sfx[evt.file];if(!audio.ended)console.log("cutting sfx short "+file);audio.play()}};class NodeView extends BaseListener{constructor(){super();this.pos=new Vec2D;this.size=new Vec2D;this.rotation=0;this.scale=1;this._visible=true;this.pUser=null;this.children=[];this.parent=null;this.actions=[];this.fnCustomDraw=[];this.fnOnClick=null;this.onClickCallChildren=true}Destroy(){if(this.textInput)this.textInput.destroy();for(var child of this.children)child.Destroy();super.Destroy()}get visible(){return this._visible}set visible(val){this._visible=val;if(this.textInput)this.textInput.enabled=
val}get worldRotation(){if(this.parent)return this.parent.worldRotation+this.rotation;return this.rotation}setUserData(data){this.pUser=data}getUserData(){return this.pUser}setCircle(radius,fillStyle,strokeStyle){if(this.circleRadius){console.error("NodeView: already has a circle, abort!");return}this.circleRadius=radius;var self=this;this.fnCustomDraw.push(function(gfx,x,y,ct){gfx.drawCircleEx(x,y,self.circleRadius,fillStyle,strokeStyle)})}setRect(w,h,fillStyle){this.size.setVal(Math.max(this.size.x,
w),Math.max(this.size.y,h));this.fnCustomDraw.push(function(gfx,x,y,ct){gfx.drawRectEx(x,y,w,h,fillStyle)})}setPolygon(arrVerts,fill,stroke,strokeSize){this.fnCustomDraw.push(function(gfx,x,y,ct){gfx.drawPolygonEx(arrVerts,fill,stroke,strokeSize)})}setImage(image){if(isString(image)){var RP=Service.Get("rp");image=RP.getImage(image)}if(this.image){console.error("NodeView: already has an image, abort!");return}this.image=image;this.size.setVal(Math.max(this.size.x,image.width),Math.max(this.size.y,
image.height));var self=this;this.fnCustomDraw.push(function(gfx,x,y,ct){gfx.drawImage(self.image,x,y)})}setImageStretch(image,x,y,w,h){if(isString(image)){var RP=Service.Get("rp");image=RP.getImage(image)}if(this.image){console.error("NodeView: already has an image, abort!");return}this.image=image;this.size.setVal(Math.max(this.size.x,image.width),Math.max(this.size.y,image.height));var self=this;this.fnCustomDraw.push(function(gfx,x,y,ct){gfx.drawImageEx(self.image,x,y,w,h)})}setSprite(sprite,
spriteFrame,hFlip){hFlip=hFlip||false;if(isString(sprite)){var RP=Service.Get("rp");sprite=RP.getSprite(sprite)}if(this.sprite){console.error("NodeView: already has a sprite, abort!");return}this.sprite=sprite;this.spriteFrame=spriteFrame;this.hFlip=hFlip;this.size.setVal(Math.max(this.size.x,sprite.getWidth()),Math.max(this.size.y,sprite.getHeight()));var self=this;this.fnCustomDraw.push(function(gfx,x,y,ct){self.sprite.drawFrame(gfx,x,y,self.spriteFrame,self.hFlip)})}setAnim(anim){if(this.animInstance){console.error("NodeView: already has an anim, abort!");
return}this.animInstance=new AnimationInstance(anim);var self=this;this.fnCustomDraw.push(function(gfx,x,y,ct){self.animInstance.update(ct);self.animInstance.Draw(gfx,x,y,self.hFlip)});this.animEvent=function(ct,evt){this.animInstance.event(ct,evt)};this.startAnim=function(ct,animState){this.animInstance.startAnim(ct,animState)}}setLabel(labelText,labelFont,labelStyle,multiLine){if(this.labelText){console.error("NodeView: already has a label, abort!");return}this.labelMultiLine=multiLine||false;this.labelText=
labelText;this.labelFont=labelFont;this.labelStyle=labelStyle;var gfx=Service.Get("gfx");var textSize=gfx.getTextSize(this.labelText,this.labelFont,this.labelMultiLine);this.size.setVal(Math.max(this.size.x,textSize.x),Math.max(this.size.y,textSize.y));var self=this;this.fnCustomDraw.push(function(gfx,x,y,ct){gfx.drawTextEx(self.labelText,x,y,self.labelFont,self.labelStyle,self.labelMultiLine)})}updateLabel(labelText){if(!isString(this.labelText)){console.error("NodeView: cant update label, dont have one!");
return}this.labelText=labelText}updateLabelStyle(style){this.labelStyle=style}setTextInput(w,h){if(this.textInput){console.error("NodeView: already has a text input, abort!");return}var margin=2;var gfx=Service.Get("gfx");this.textInput=new CanvasInput({canvas:gfx.canvas,width:w-margin,height:h-margin,padding:0,borderRadius:margin,boxShadow:"1px 1px 0px #fff",innerShadow:"0px 0px 2px rgba(0, 0, 0, 0.5)"});this.textInput.vecPos=this.pos;this.size.setVal(Math.max(this.size.x,w),Math.max(this.size.y,
h));var self=this;this.textInput.onsubmit(function(e,canvasInput){EventBus.ui.dispatch({evtName:"textInputSubmitted",value:canvasInput.value(),node:self})});this.fnCustomDraw.push(function(gfx,x,y,ct){self.textInput.renderNow(x,y)})}getTextInputValue(){if(this.textInput)return this.textInput.value();return null}setTextInputValue(text){if(this.textInput)this.textInput.value(text)}clearTextInputValue(){if(this.textInput)this.textInput.value("")}addCustomDraw(fn){this.fnCustomDraw.push(fn)}setClick(fn,
shouldCallChildren){this.onClickCallChildren=shouldCallChildren||true;this.fnOnClick=fn}OnMouseDown(e,x,y){if(!this.visible)return;x-=this.pos.x;y-=this.pos.y;if(this.rotation!=0){var v=new Vec2D(x,y);v.rotate(-this.rotation);x=v.x;y=v.y}if(this.fnOnClick){var originX=-this.size.x/2;var originY=-this.size.y/2;if(Rect2D.isPointInArea(x,y,originX,originY,this.size.x,this.size.y)){if(this.fnOnClick)this.fnOnClick(e,x,y);if(e.isDone)return}}if(this.onClickCallChildren)for(var child of this.children){child.OnMouseDown(e,
x,y);if(e.isDone)return}}OnKeyDown(e,x,y){if(!this.visible)return;x-=this.pos.x;y-=this.pos.y;if(this.rotation!=0){var v=new Vec2D(x,y);v.rotate(-this.rotation);x=v.x;y=v.y}if(this.textInput)this.textInput.keydown(e,this.textInput);for(var child of this.children){child.OnKeyDown(e,x,y);if(e.isDone)return}}OnKeyUp(e,x,y){if(!this.visible)return;x-=this.pos.x;y-=this.pos.y;if(this.rotation!=0){var v=new Vec2D(x,y);v.rotate(-this.rotation);x=v.x;y=v.y}if(this.textInput)this.textInput.onkeyup(e,this.textInput);
for(var child of this.children){child.OnKeyUp(e,x,y);if(e.isDone)return}}getWidth(){return this.size.x}getHeight(){return this.size.y}addChild(child){child.removeFromParent();this.children.push(child);child.parent=this}removeFromParent(shouldDestroy){shouldDestroy=shouldDestroy||false;if(!this.parent)return;this.parent.removeChild(this,shouldDestroy);this.parent=null}removeChild(child,shouldDestroy){shouldDestroy=shouldDestroy||false;var childIdx=this.children.indexOf(child);this.removeChildByIdx(childIdx,
shouldDestroy)}removeChildByIdx(childIdx,shouldDestroy){shouldDestroy=shouldDestroy||false;if(childIdx<0)return;var child=this.children.splice(childIdx,1)[0];if(child.parent===this)child.parent=null;if(shouldDestroy)child.Destroy()}removeAllChildren(shouldDestroy){shouldDestroy=shouldDestroy||false;for(var i=this.children.length-1;i>=0;i--){var child=this.children[i];this.removeChild(child,shouldDestroy)}}Draw(gfx,x,y,ct){if(!this.visible)return;this.handleActions(ct);gfx.saveMatrix();gfx.translate(x+
this.pos.x,y+this.pos.y);if(this.rotation!=0)gfx.rotate(this.rotation);if(this.scale!=1)gfx.scale(this.scale);for(var f of this.fnCustomDraw)f(gfx,0,0,ct);for(var child of this.children)child.Draw(gfx,0,0,ct);gfx.restoreMatrix()}handleActions(ct){if(this.actions.length==0)return;var remove=[];for(var i=0;i<this.actions.length;i++){var action=this.actions[i];if(action.isDone)remove.push(i);else action.Update(ct)}if(remove.length>0)for(var e=remove.length-1;e>=0;e--)this.actions.splice(remove[e],1)}tweenScale(dt,
endVal){this.setTween("scale",dt,endVal)}tweenPos(dt,endVal){this.setVecTween("pos",dt,endVal)}setTween(paramName,dt,endVal){var action=new NodeAction_float(paramName,dt,endVal);action.setTarget(this);this.actions.push(action)}setVecTween(paramName,dt,endVal){var action=new NodeAction_vec2d(paramName,dt,endVal);action.setTarget(this);this.actions.push(action)}}
class NodeAction{constructor(propertyName,lifeTime,endVal){this.startTime=0;this.lifeTime=lifeTime;this.target=null;this.propertyName=propertyName;this.isDone=false;this.fnOnComplete=null;this.startVal=null;this.endVal=endVal}Destroy(){this.target=null}setTarget(target){this.target=target;this.startVal=this.target[this.propertyName]}_calculateDT(ct){var dt=ct-this.startTime;if(dt<0)return 0;else if(dt>=this.lifeTime)return 1;else return dt/this.lifeTime}Update(ct){if(this.startTime==0)this.startTime=
ct;var pct=this._calculateDT(ct);if(pct>=1){this.target[this.propertyName]=this.endVal;this.isDone=true;if(this.fnOnComplete){this.fnOnComplete();this.fnOnComplete=null}}else{var interp=this.getInterpolatedVal(pct);this.target[this.propertyName]=interp}}getInterpolatedVal(pct){}}class NodeAction_float extends NodeAction{getInterpolatedVal(dt){var delta=this.endVal-this.startVal;return this.startVal+delta*dt}}
class NodeAction_vec2d extends NodeAction{getInterpolatedVal(dt){var delta=this.endVal.getVecSub(this.startVal);return this.startVal.getVecAdd(delta.scalarMult(dt))}};class ButtonView extends NodeView{static get STATE_NORMAL(){return 0}static get STATE_PRESSED(){return 1}constructor(btnID,sprite,label,labelFont,labelStyle,onClickData){labelFont=labelFont||"10px Arial";labelStyle=labelStyle||"#CCCCCC";super();this.state=ButtonView.STATE_NORMAL;this.size=new Vec2D;this.evt=onClickData||{};this.evt["evtName"]=btnID;if(isString(sprite)){var RP=Service.Get("rp");sprite=RP.getSprite(sprite)}if(sprite)this.setSprite(sprite);this.setLabel(label,labelFont,labelStyle);this.unPressHandler=
null}Destroy(){if(this.unPressHandler)clearTimeout(this.unPressHandler);this.unPressHandler=null;super.Destroy()}setSprite(sprite){super.setSprite(sprite);this.size.setVal(sprite.getWidth(),sprite.getHeight())}Draw(gfx,x,y,ct){this.spriteFrame=this.state;super.Draw(gfx,x,y,ct)}OnMouseDown(e,x,y){x-=this.pos.x;y-=this.pos.y;if(this.rotation!=0){var v=new Vec2D(x,y);v.rotate(-this.rotation);x=v.x;y=v.y}var originX=0;var originY=0;if(Config.areSpritesCentered){originX-=this.size.x/2;originY-=this.size.y/
2}if(Rect2D.isPointInArea(x,y,originX,originY,this.size.x,this.size.y))if(this.state==ButtonView.STATE_NORMAL){this.state=ButtonView.STATE_PRESSED;EventBus.ui.dispatch(this.evt);var self=this;this.unPressHandler=setTimeout(function(){self.state=ButtonView.STATE_NORMAL},.15*1E3);e.isDone=true;return}super.OnMouseDown(e,x,y)}};class EventBus{constructor(strBusName){this.listeners={};this.busName=strBusName;this.verbose=true}Destroy(){for(var evt of this.listeners)this.clearListeners(evt)}addListener(strEventName,callbackFunction){if(!(strEventName in this.listeners))this.listeners[strEventName]=[];this.listeners[strEventName].push(callbackFunction)}removeListener(strEventName,callbackFunction){if(!(strEventName in this.listeners))return;var idx=this.listeners[strEventName].indexOf(callbackFunction);this.listeners[strEventName].splice(idx,
1)}clearListeners(strEventName){this.listeners[strEventName]=[]}dispatch(evtObj){if(typeof evtObj==="string"||evtObj instanceof String)evtObj={"evtName":evtObj};if(!evtObj.evtName){console.log("abort dispatch event -- no evtName %O",evtObj);return}if(this.verbose)console.log("EB["+this.busName+"] "+evtObj.evtName+":%O",evtObj);if(!this.listeners[evtObj.evtName])return;this.listeners[evtObj.evtName].forEach(function(ele,idx,arr){ele(evtObj)})}static Get(strBusName){if(!this.g_eventBuses)this.g_eventBuses=
{};if(!this.g_eventBuses[strBusName])this.g_eventBuses[strBusName]=new EventBus(strBusName);return this.g_eventBuses[strBusName]}static get game(){return this.Get("game")}static get ui(){return this.Get("ui")}static get sfx(){return this.Get("sfx")}};class Graphics{constructor(strCanvasName){this.canvas=document.getElementById(strCanvasName);this.fillStyle="#FF0000";this.strokeStyle="#FFFFFF";this.strokeSize=1;this.font="30px Arial";this.ctx=this.canvas.getContext("2d");this.drawCentered=Config?Config.areSpritesCentered:false;this.verbose=false;Service.Add("gfx",this)}getWidth(){return this.canvas.clientWidth}getHeight(){return this.canvas.clientHeight}begin(bShouldClear){this.ctx=this.canvas.getContext("2d");if(bShouldClear)this.clearAll()}clearAll(){this.ctx.clearRect(0,
0,this.getWidth(),this.getHeight())}saveMatrix(){this.ctx.save()}restoreMatrix(){this.ctx.restore()}translate(x,y){this.ctx.translate(x,y)}rotate(radians,ccw){if(ccw)radians*=-1;this.ctx.rotate(radians)}scale(scaleVal){this.ctx.scale(scaleVal,scaleVal)}_setStyle(param,selfParam){if(param=="")return false;if(param==undefined)return selfParam;return param}drawRect(x,y,w,h){this.ctx.fillStyle=this.fillStyle;if(this.verbose)console.log("rect at "+x+","+y+" x "+w+","+h);if(this.drawCentered){x-=w/2;y-=
h/2}this.ctx.fillRect(x,y,w,h)}drawRectEx(x,y,w,h,fillStyle){this.ctx.fillStyle=fillStyle||this.fillStyle;if(this.verbose)console.log("rect at "+x+","+y+" x "+w+","+h);if(this.drawCentered){x-=w/2;y-=h/2}this.ctx.fillRect(x,y,w,h)}drawRectOutline(x,y,w,h){this.ctx.strokeStyle=this.strokeStyle;this.ctx.lineWidth=this.strokeSize;if(this.verbose)console.log("rect at "+x+","+y+" x "+w+","+h);if(this.drawCentered){x-=w/2;y-=h/2}this.ctx.strokeRect(x,y,w,h)}drawRectOutlineEx(x,y,w,h,strokeStyle,strokeWidth){this.ctx.strokeStyle=
strokeStyle||this.strokeStyle;this.ctx.lineWidth=strokeWidth||this.strokeSize;if(this.verbose)console.log("rect at "+x+","+y+" x "+w+","+h);if(this.drawCentered){x-=w/2;y-=h/2}this.ctx.strokeRect(x,y,w,h)}drawPolygonEx(verts,fillStyle,strokeStyle,strokeSize){var fs=this._setStyle(fillStyle,this.fillStyle);var ss=this._setStyle(strokeStyle,this.strokeStyle);this.ctx.fillStyle=fs;this.ctx.strokeStyle=ss;this.ctx.lineWidth=strokeSize||this.strokeSize;this.ctx.beginPath();var vert=verts[0];this.ctx.moveTo(vert.x,
vert.y);for(var i=1;i<verts.length;i++)this.ctx.lineTo(verts[i].x,verts[i].y);this.ctx.closePath();if(fs)this.ctx.fill();if(ss)this.ctx.stroke()}drawCubicBezierEx(verts,fillStyle,strokeStyle,strokeSize){var fs=this._setStyle(fillStyle,this.fillStyle);var ss=this._setStyle(strokeStyle,this.strokeStyle);this.ctx.fillStyle=fs;this.ctx.strokeStyle=ss;this.ctx.lineWidth=strokeSize||this.strokeSize;if(verts.length!=4){console.warn("Graphics.drawCubicBezierEx() - invalid number of verts, must be 4");return}this.ctx.beginPath();
this.ctx.moveTo(verts[0].x,verts[0].y);this.ctx.bezierCurveTo(verts[1].x,verts[1].y,verts[2].x,verts[2].y,verts[3].x,verts[3].y);this.ctx.closePath();if(fs)this.ctx.fill();if(ss)this.ctx.stroke()}drawLine(x1,y1,x2,y2){this.ctx.strokeStyle=this.strokeStyle;this.ctx.lineWidth=this.strokeSize;this.ctx.beginPath();this.ctx.moveTo(x1,y1);this.ctx.lineTo(x2,y2);this.ctx.stroke();this.ctx.closePath();if(this.verbose)console.log("line at "+x1+","+y1+" x "+x2+","+y2)}drawLineEx(x1,y1,x2,y2,strokeStyle,strokeSize){this.ctx.strokeStyle=
strokeStyle||this.strokeStyle;this.ctx.lineWidth=strokeSize||this.strokeSize;this.ctx.beginPath();this.ctx.moveTo(x1,y1);this.ctx.lineTo(x2,y2);this.ctx.stroke();this.ctx.closePath();if(this.verbose)console.log("line at "+x1+","+y1+" x "+x2+","+y2)}drawCircle(x1,y1,radius){var fs=this.fillStyle;var ss=this.strokeStyle;this.ctx.fillStyle=fs;this.ctx.strokeStyle=ss;this.ctx.lineWidth=this.strokeSize;this.ctx.beginPath();this.ctx.arc(x1,y1,radius,0,2*Math.PI,false);this.ctx.closePath();if(fs)this.ctx.fill();
if(ss)this.ctx.stroke();if(this.verbose)console.log("circle at "+x1+","+y1+" x "+radius)}drawCircleEx(x1,y1,radius,fillStyle,strokeStyle,strokeSize){var fs=this._setStyle(fillStyle,this.fillStyle);var ss=this._setStyle(strokeStyle,this.strokeStyle);this.ctx.fillStyle=fs;this.ctx.strokeStyle=ss;this.ctx.lineWidth=strokeSize||this.strokeSize;this.ctx.beginPath();this.ctx.arc(x1,y1,radius,0,2*Math.PI,false);this.ctx.closePath();if(fs)this.ctx.fill();if(ss)this.ctx.stroke()}drawText(strText,x,y){this.ctx.font=
this.font;this.ctx.fillStyle=this.fillStyle;if(this.drawCentered){var sized=this.ctx.measureText(strText);x-=sized.width/2}this.ctx.fillText(strText,x,y)}drawTextEx(strText,x,y,font,fillStyle,multiLine){this.ctx.font=font;this.ctx.fillStyle=fillStyle||this.fillStyle;if(!multiLine){if(this.drawCentered){var sized=this.ctx.measureText(strText);x-=sized.width/2}this.ctx.fillText(strText,x,y)}else{var lines=strText.split("\n");var h=this.ctx.measureText("m").width*1.5;for(var line of lines){var lx=x;
if(this.drawCentered){var lineWidth=this.ctx.measureText(line).width;lx-=lineWidth/2}this.ctx.fillText(line,lx,y);y+=h}}}getTextSize(text,font,multiLine){this.ctx.font=font||this.font;var numLines=0;var w=0;if(multiLine){var lines=text.split("\n");for(var line of lines){var lineWidth=this.ctx.measureText(line).width;if(lineWidth>w)w=lineWidth;numLines++}}else{numLines=1;w=this.ctx.measureText(text).width}var h=this.ctx.measureText("m").width*numLines*1.5;return new Vec2D(w,h)}drawImage(img,x,y){if(this.drawCentered){x-=
img.width/2;y-=img.height/2}this.ctx.drawImage(img,x,y)}drawImageEx(img,x,y,w,h,hFlip){if(!hFlip)this.ctx.drawImage(img,0,0,img.width,img.height,x,y,w,h);else{this.ctx.save();this.ctx.scale(-1,1);this.ctx.drawImage(img,0,0,img.width,img.height,x*-1-img.width,y,w,h);this.ctx.restore()}}drawImageSub(img,dx,dy,srcx,srcy,srcw,srch,hFlip){if(this.drawCentered){dx-=srcw/2;dy-=srch/2}if(!hFlip)this.ctx.drawImage(img,srcx,srcy,srcw,srch,dx,dy,srcw,srch);else{this.ctx.save();this.ctx.scale(-1,1);this.ctx.drawImage(img,
srcx,srcy,srcw,srch,dx*-1-srcw,dy,srcw,srch);this.ctx.restore()}}drawImageTiled(img,x,y,w,h,scale){if(this.drawCentered){x-=w/2;y-=h/2}scale=scale||1;var tileW=img.width*scale;var tileH=img.height*scale;var numTilesW=w/tileW;var numTilesH=h/tileH;for(var ty=0;ty<numTilesH;ty++)for(var tx=0;tx<numTilesW;tx++)this.ctx.drawImage(img,x+tx*tileW,y+ty*tileH,tileW,tileH)}}
class Sprite{constructor(path){this.fullPath=path;this.path=path.substring(0,path.lastIndexOf("/")+1);this.img=null;this.data=null;this.isLoaded=false}_load(dataJson,fnOnLoad){var resourceProvider=Service.Get("rp");this.data=dataJson;this.format=dataJson["format"]||"xywh";var self=this;this.img=resourceProvider.getImage(this.path+dataJson["image"],function(e){if(!self.isLoaded){self.img=e.res;self.isLoaded=true;if(self.verbose)console.log("sprite loaded late: "+self.fullPath);if(fnOnLoad)fnOnLoad()}});
if(this.img){this.isLoaded=this.img.isLoaded;if(this.verbose)console.log("sprite loaded immediately: "+self.fullPath);if(this.isLoaded&&fnOnLoad)fnOnLoad()}}getWidth(){return this.data.width-this.getPaddingX()*2}getHeight(){return this.data.height-this.getPaddingY()*2}getPaddingX(){return this.data.paddingX||0}getPaddingY(){return this.data.paddingY||0}getFPS(){return this.data.fps||30}getNumFrames(){if(this.format=="xywh"||this.format=="gridSub")return this.data.frames.length;else if(this.format==
"grid"){var frameW=this.data.width;var frameH=this.data.height;var texW=this.img.width;var framesPerRow=Math.floor(texW/frameW);var numRows=Math.floor(this.img.height/frameH);return numRows*framesPerRow}return 0}drawFrame(gfx,x,y,frameIdx,hFlip){if(this.format=="xywh"){var frameData=this.data.frames[frameIdx];gfx.drawImageSub(this.img,x-this.getPaddingX(),y-this.getPaddingY(),frameData[0],frameData[1],frameData[2],frameData[3],hFlip)}else if(this.format=="grid"||this.format=="gridSub"){if(this.format==
"gridSub")frameIdx=this.data.frames[frameIdx];var frameW=this.data.width;var frameH=this.data.height;var texW=this.img.width;var framesPerRow=Math.floor(texW/frameW);var row=frameIdx%framesPerRow;var col=(frameIdx-row)/framesPerRow;gfx.drawImageSub(this.img,x-this.getPaddingX(),y-this.getPaddingY(),row*frameW,col*frameH,frameW,frameH,hFlip)}}};class LoadingState extends AppState{constructor(params){super();this.view=new LoadingView(params[0],params[1])}}
class LoadingView extends BaseStateView{constructor(resNameArr,nextStateName){super();this.resLoaded=0;this.resToLoad=resNameArr;this.numToLoadTotal=resNameArr.length;this.loadingName="";this.nextStateName=nextStateName;this._loadNext()}_loadNext(){var RP=Service.Get("rp");if(this.resToLoad.length==0){this.loadingName="completed";EventBus.ui.dispatch({evtName:"loadingComplete"});if(this.nextStateName){var stateController=Service.Get("state");stateController.gotoState(this.nextStateName)}return}this.loadingName=
this.resToLoad[0];this.resToLoad.splice(0,1);var self=this;var ext=this.loadingName.substr(this.loadingName.lastIndexOf(".")+1);switch(ext){case "png":case "PNG":case "bmp":case "BMP":case "jpg":case "JPG":RP.loadImage(this.loadingName,function(e){self._loadNext()});break;case "sprite":RP.loadSprite(this.loadingName,function(e){self._loadNext()});break;default:RP.loadJson(this.loadingName,function(e){self._loadNext()});break}}Draw(g,x,y,ct){g.drawRectEx(g.getWidth()/2,g.getHeight()/2,g.getWidth(),
g.getHeight(),"#000000");g.drawText("(%) loading: "+this.loadingName,g.getWidth()/2,50)}};class TableView extends NodeView{static get VERTICAL(){return 0}static get HORIZONTAL(){return 1}constructor(w,h){super();this.m_cells=[];this.m_scrollOffsetX=0;this.m_scrollOffsetY=0;this.padding=5;this.size.setVal(w,h);this.direction=TableView.VERTICAL}addCell(cell){this.m_cells.push(cell)}removeCellAtIndex(idx){this.m_cells=this.m_cells.splice(idx,1)}OnMouseDown(e,x,y){x-=this.pos.x;y-=this.pos.y;x-=this.m_scrollOffsetX;y-=this.m_scrollOffsetY;var off=0;if(this.direction==TableView.VERTICAL)for(var i=
0;i<this.m_cells.length;i++){this.m_cells[i].OnMouseDown(e,x,y-off);if(e.isDone)return;off+=this.m_cells[i].getHeight()+this.padding}else for(var i=0;i<this.m_cells.length;i++){this.m_cells[i].OnMouseDown(e,x-off,y);if(e.isDone)return;off+=this.m_cells[i].getWidth()+this.padding}}Draw(gfx,x,y,ct){gfx.saveMatrix();gfx.translate(x+this.pos.x,y+this.pos.y);x-=this.m_scrollOffsetX;y-=this.m_scrollOffsetY;var off=0;if(this.direction==TableView.VERTICAL)for(var i=0;i<this.m_cells.length;i++){this.m_cells[i].Draw(gfx,
0,off,ct);off+=this.m_cells[i].getHeight()+this.padding}else for(var i=0;i<this.m_cells.length;i++){this.m_cells[i].Draw(gfx,off,0,ct);off+=this.m_cells[i].getWidth()+this.padding}for(var child of this.children)child.Draw(gfx,0,0,ct);gfx.restoreMatrix()}};class ParticleModel{constructor(){this.pos=new Vec2D;this.vel=new Vec2D;this.reinit()}reinit(){this.pos.setVal(0,0);this.vel.setVal(0,0);this.startTime=0;this.endTime=0;this.size=1;this.sprite=null;this.fillStyle="#FF0000"}}
class ParticleSystem{constructor(poolSize){this.lastUpdate=0;this.freeParticles=[];this.livingParticles=[];for(var i=0;i<poolSize;i++)this.freeParticles.push(new ParticleModel)}draw(gfx,x,y,ct){if(this.lastUpdate==0)this.lastUpdate=ct;var dt=ct-this.lastUpdate;for(var i=0;i<this.livingParticles.length;i++){var p=this.livingParticles[i];if(p.endTime<=ct){this.freeParticles.push(p);this.livingParticles.splice(i,1);p.reinit();i--}else{p.pos.addVec(p.vel.getScalarMult(dt));if(p.sprite){var _dt=ct-p.startTime;
var frame=Math.floor(_dt*p.sprite.getFPS())%p.sprite.getNumFrames();p.sprite.drawFrame(gfx,x+p.pos.x,y+p.pos.y,frame)}else gfx.drawRectEx(x+p.pos.x,y+p.pos.y,p.size,p.size,p.fillStyle)}}}spawn(x,y,vx,vy,ct,lifespan){if(this.freeParticles.length<1)return;var p=this.freeParticles.pop();this.livingParticles.push(p);p.startTime=ct;p.endTime=ct+lifespan;p.pos.setVal(x,y);p.vel.setVal(vx,vy)}spawnAnimated(x,y,vx,vy,ct,sprite){if(this.freeParticles.length<1)return;var p=this.freeParticles.pop();this.livingParticles.push(p);
p.startTime=ct;var lifespan=sprite.getNumFrames()/sprite.getFPS();p.endTime=ct+lifespan;p.pos.setVal(x,y);p.vel.setVal(vx,vy);p.sprite=sprite}};class Physics{constructor(){Service.Add("physics",this)}DrawDebug(){}Tick(){}};class ResourceProvider{constructor(){this.eventBus=new EventBus("RP");this.images={};this.numImagesLoading=0;this.sprites={};this.numSpritesLoading=0;this.jsonFiles={};this.numJsonFilesLoading=0;this.dynamicRes={};this.baseURL="";this.verbose=false;Service.Add("rp",this)}isLoading(){if(this.numImagesLoading>0)return true;if(this.numSpritesLoading>0)return true;if(this.numJsonFilesLoading>0)return true;return false}_didLoad(fileName,resource){this.eventBus.dispatch({"evtName":fileName,"status":"loadComplete",
"res":resource});this.eventBus.clearListeners(fileName)}getImage(fileName,fnOnLoad){if(!this.images[fileName]||!this.images[fileName].isLoaded){this.loadImage(fileName,fnOnLoad);return}if(fnOnLoad)fnOnLoad({"evtName":fileName,"status":"loadComplete","res":this.images[fileName]});return this.images[fileName]}loadImage(fileName,fnOnLoad){var RP=this;if(this.images[fileName]){if(this.images[fileName].isLoaded){if(fnOnLoad)fnOnLoad({"evtName":fileName,"status":"loadComplete","res":this.images[fileName]})}else if(fnOnLoad)RP.eventBus.addListener(fileName,
fnOnLoad);return}if(this.verbose)console.log("load image "+fileName);var img=new Image;img.isLoaded=false;img.src=this.baseURL+fileName;this.images[fileName]=img;if(fnOnLoad)RP.eventBus.addListener(fileName,fnOnLoad);img.onload=function(){RP.images[fileName].isLoaded=true;RP.numImagesLoading--;RP._didLoad(fileName,RP.images[fileName])};if(img.complete)console.warn("image already complete, abort loading");else this.numImagesLoading++}getSprite(fileName,fnOnLoad){if(!this.sprites[fileName]||!this.sprites[fileName].isLoaded){this.loadSprite(fileName,
fnOnLoad);return}if(fnOnLoad)fnOnLoad({"evtName":fileName,"status":"loadComplete","res":this.sprites[fileName]});return this.sprites[fileName]}loadSprite(fileName,fnOnLoad){var RP=this;if(this.sprites[fileName]){if(this.sprites[fileName].isLoaded){if(fnOnLoad)fnOnLoad({"evtName":fileName,"status":"loadComplete","res":this.sprites[fileName]})}else if(fnOnLoad)RP.eventBus.addListener(fileName,fnOnLoad);return}if(this.verbose)console.log("load sprite "+fileName);var sprite=new Sprite(fileName);if(fnOnLoad)RP.eventBus.addListener(fileName,
fnOnLoad);getJSON(this.baseURL+fileName,function(data){if(RP.verbose)console.log("sprite loaded: "+fileName);RP.sprites[fileName]._load(data,function(){RP.numSpritesLoading--;RP._didLoad(fileName,RP.sprites[fileName])})});this.sprites[fileName]=sprite;this.numSpritesLoading++}getJson(fileName,fnOnLoad){if(!this.jsonFiles[fileName]||!this.jsonFiles[fileName].isLoaded){this.loadJson(fileName,fnOnLoad);return}if(fnOnLoad)fnOnLoad({"evtName":fileName,"status":"loadComplete","res":this.jsonFiles[fileName].data});
return this.jsonFiles[fileName].data}loadJson(fileName,fnOnLoad){var RP=this;if(this.jsonFiles[fileName]){if(this.jsonFiles[fileName].isLoaded){if(fnOnLoad)fnOnLoad({"evtName":fileName,"status":"loadComplete","res":this.jsonFiles[fileName].data})}else if(fnOnLoad)RP.eventBus.addListener(fileName,fnOnLoad);return}if(this.verbose)console.log("load json: "+fileName);if(fnOnLoad)RP.eventBus.addListener(fileName,fnOnLoad);getJSON(this.baseURL+fileName,function(data){if(this.verbose)console.log("json loaded: "+
fileName);RP.jsonFiles[fileName].data=data;RP.jsonFiles[fileName].isLoaded=true;RP.numJsonFilesLoading--;RP._didLoad(fileName,RP.jsonFiles[fileName].data)});if(this.verbose)console.log("json being loaded: "+fileName);this.jsonFiles[fileName]={file:fileName,data:null,isLoaded:false};this.numJsonFilesLoading++}setResource(fileName,res){if(this.dynamicRes.hasOwnProperty(fileName)){console.warn("tried to set already existing resource "+fileName);return}this.dynamicRes[fileName]=res}getResource(fileName){return this.dynamicRes[fileName]}}
;class SaveData{constructor(appPrefix){this.appPrefix=appPrefix;Service.Add("sd",this);this.verbose=true}init(strName,objData){var val=localStorage.getItem(this.appPrefix+strName);if(val===null){this.save(strName,objData);if(this.verbose)console.log("saved initial value for "+strName)}}save(strName,objData){localStorage.setItem(this.appPrefix+strName,JSON.stringify(objData))}load(strName,defaultValue){var val=localStorage.getItem(this.appPrefix+strName);if(val===null){if(this.verbose)console.log("used default value for load of ",
strName);return defaultValue}return JSON.parse(val)}clear(strName){localStorage.removeItem(this.appPrefix+strName)}};class TiledMap{constructor(path,outputW,outputH){this.path=path.substring(0,path.lastIndexOf("/")+1);this.width=outputW;this.height=outputH;this.isLoaded=false;this.imgLayers=[];this.groundRects=[];this.wallRects=[];this.spawnPts=[];this.pPhysics=null;this.physicsBodies=[];this.debugShowBoxes=false}LoadFromJson(dataJson){var rp=Service.Get("rp");this.data=dataJson;for(var layerIdx=0;layerIdx<this.data.layers.length;layerIdx++){var layer=this.data.layers[layerIdx];if(layer.type=="imagelayer"){this.imgLayers.push(layer);
rp.loadImage(this.path+layer.image)}else if(layer.type=="objectgroup"&&layer.name=="ground")for(var objIdx=0;objIdx<layer.objects.length;objIdx++){var object=layer.objects[objIdx];this.groundRects.push(object)}else if(layer.type=="objectgroup"&&layer.name=="wall")for(var objIdx=0;objIdx<layer.objects.length;objIdx++){var object=layer.objects[objIdx];this.wallRects.push(object)}else if(layer.type=="objectgroup"&&layer.name=="spawn")for(var objIdx=0;objIdx<layer.objects.length;objIdx++){var object=
layer.objects[objIdx];this.spawnPts.push(object)}}this.isLoaded=true}Draw(gfx,offsetX,offsetY){if(!this.isLoaded)return;var rp=Service.Get("rp");for(var layerIdx=0;layerIdx<this.imgLayers.length;layerIdx++){var layer=this.data.layers[layerIdx];var layerImg=rp.getImage(this.path+layer.image);if(layerImg)gfx.drawImage(layerImg,offsetX+layer.x,offsetY+layer.y)}if(this.debugShowBoxes){for(var objIdx=0;objIdx<this.groundRects.length;objIdx++){var object=this.groundRects[objIdx];gfx.drawRect(offsetX+object.x,
offsetY+object.y,object.width,object.height)}for(var objIdx=0;objIdx<this.wallRects.length;objIdx++){var object=this.wallRects[objIdx];gfx.drawRect(offsetX+object.x,offsetY+object.y,object.width,object.height)}for(var objIdx=0;objIdx<this.spawnPts.length;objIdx++){var object=this.spawnPts[objIdx];gfx.drawRect(offsetX+object.x,offsetY+object.y,object.width,object.height)}}}AttachPhysics(physics){if(!this.isLoaded)return;if(this.physics!=null){console.log("warn: already attached to physics");return}this.physics=
physics;for(var objIdx=0;objIdx<this.groundRects.length;objIdx++){var object=this.groundRects[objIdx];var stdGroundHeight=10;object.height=stdGroundHeight;var body=physics.createStaticBody(object.x,object.y,object.width,object.height);body.SetUserData({"objLink":this,"isGround":true,"isWall":false});this.physicsBodies.push(body)}for(var objIdx=0;objIdx<this.wallRects.length;objIdx++){var object=this.wallRects[objIdx];var body=physics.createStaticBody(object.x,object.y,object.width,object.height);
body.SetUserData({"objLink":this,"isGround":false,"isWall":true});this.physicsBodies.push(body)}}DetatchPhysics(){if(!this.physics)return;for(var objIdx=0;objIdx<this.physicsBodies.length;objIdx++){var body=this.physicsBodies[objIdx];this.physics.destroyBody(body)}this.physics=null}GetSpawnPoint(idx){return this.spawnPts[idx]}GetRandomSpawn(){var min=0;var max=this.spawnPts.length-1;var idx=Math.floor(Math.random()*(max-min))+min;return this.spawnPts[idx]}GetSpawnFurthestFrom(x,y){var dist=0;var idx=
0;for(var i=0;i<this.spawnPts.length;i++){var thisDistEst=Math.abs(this.spawnPts.x-x)+Math.abs(this.spawnPts.y-y);if(thisDistEst>dist)idx=i}return this.spawnPts[idx]}};function getRand(min,max){return~~(Math.random()*(max-min+1))+min}function dicLength(dictionary){return Object.keys(dictionary).length}function arrayContains(array,element){if(array.some(function(e){return e==element}))return true;return false}function isString(obj){return typeof obj==="string"||obj instanceof String}function isArray(obj){return obj.constructor===Array||Array.isArray(obj)}
function getJSON(url,fnCallback){var request=new XMLHttpRequest;request.open("GET",url,true);request.onload=function(){if(this.status>=200&&this.status<400||this.status==0&&this.response){var data=JSON.parse(this.response);fnCallback(data)}else{console.error("unable to download "+url+" error: "+this.status+" "+this.statusText);fnCallback(null)}};request.onerror=function(){console.error("unable to download "+url+" unable to connect");fnCallback(null)};request.send()}
function CreateSimpleButton(strLabel,strEvt,strBus){var area=new Vec2D(100,40);var btn=new NodeView;btn.setRect(area.x,area.y,"rgb(50,150,50)");btn.setLabel(strLabel);btn.setClick(function(){EventBus.Get(strBus).dispatch({evtName:strEvt,from:btn})});return btn}
function CreateSimplePopup(strMsg,strBtnLabel,okEvt,strBus){var area=new Vec2D(300,250);var pop=new NodeView;pop.setRect(area.x,area.y,"rgb(200,200,200)");var btn=CreateSimpleButton(strBtnLabel,okEvt,strBus);btn.pos.y=area.y/2;pop.addChild(btn);console.log("button size "+btn.size.x+","+btn.size.y);area.y-=btn.size.y;var label=new NodeView;label.setLabel(strMsg,"24px Arial","rgb(0,0,0)",true);label.pos.y=area.y;pop.addChild(label);return pop}
function CreateSimpleEditBox(strMsg,strDefaultTxt,strBtnLabel,okEvt,strBus){var area=new Vec2D(300,250);var pop=new NodeView;pop.setRect(area.x,area.y,"rgb(200,200,200)");console.log("button size "+btn.size.x+","+btn.size.y);area.y-=btn.size.y;var label=new NodeView;label.setLabel(strMsg,"24px Arial","rgb(0,0,0)",true);label.pos.y=area.y;pop.addChild(label);var tf=new NodeView;tf.setTextInput(250,50);tf.pos.setVal(area.x/2,50);pop.addChild(tf);var btn=CreateSimpleButton(strBtnLabel,okEvt,strBus);
btn.pos.y=area.y/2;pop.addChild(btn);return pop};class Vec2D{constructor(x,y){this.x=x||0;this.y=y||0}initializeWithPos(posObj){this.x=posObj.x;this.y=posObj.y}clone(){return new Vec2D(this.x,this.y)}toString(){return this.x.toFixed(4)+","+this.y.toFixed(4)}setVal(x,y){this.x=x;this.y=y;return this}setVec(vec2){this.x=vec2.x;this.y=vec2.y;return this}addVec(vec2){this.x+=vec2.x;this.y+=vec2.y;return this}subVec(vec2){this.x-=vec2.x;this.y-=vec2.y;return this}scalarMult(scalar){this.x=this.x*scalar;this.y=this.y*scalar;return this}nonZero(){if(this.x!=
0||this.y!=0)return true;return false}getUnitized(){var mag=this.getMag();return new Vec2D(this.x/mag,this.y/mag)}getMagSq(){return this.x*this.x+this.y*this.y}getMag(){return Math.sqrt(this.x*this.x+this.y*this.y)}getScalarMult(scalar){return new Vec2D(this.x*scalar,this.y*scalar)}getVecAdd(vec2){return new Vec2D(this.x+vec2.x,this.y+vec2.y)}getVecSub(vec2){return new Vec2D(this.x-vec2.x,this.y-vec2.y)}getDistSqFromVec(vec2){var delta=vec2.getVecSub(this);return delta.getMagSq()}equalsVec(vec2){if(this.x==
vec2.x&&this.y==vec2.y)return true;return false}toRadians(){if(this.y==0&&this.x==0)return 0;return Math.atan2(this.y,this.x)+Math.PI/2}fromRadians(phi){phi-=Math.PI/2;this.x=Math.cos(phi);this.y=Math.sin(phi);return this}static getVecFromRadians(phi){phi-=Math.PI/2;return new Vec2D(Math.cos(phi),Math.sin(phi))}rotate(phi){if(this.x==0&&this.y==0)return this;var c=Math.cos(phi);var s=Math.sin(phi);var x=this.x*c-this.y*s;var y=this.x*s+this.y*c;if(Math.abs(x)<1E-7)x=0;if(Math.abs(y)<1E-7)y=0;this.x=
x;this.y=y;return this}getVecRotation(phi){if(this.x==0&&this.y==0)return new Vec2D(0,0);var c=Math.cos(phi);var s=Math.sin(phi);var x=this.x*c-this.y*s;var y=this.x*s+this.y*c;if(Math.abs(x)<1E-7)x=0;if(Math.abs(y)<1E-7)y=0;return new Vec2D(x,y)}}
class Segment2D{constructor(startVec,endVec){this.s=startVec;this.e=endVec}SegmentWithValues(x1,y1,x2,y2){return new Segment2D(new Vec2D(x1,y1),new Vec2D(x2,y2))}isSegmentIntersected(bySegment,outIntersectionPt){return Segment2D.SegmentIntersectsSegment(this.s,this.e,bySegment.s,bySegment.e,outIntersectionPt)}SegmentIntersectsSegment(a1,a2,b1,b2,outIntersectionPt){outIntersectionPt=new Vec2D;var b=a2.getVecSub(a1);var d=b2.getVecSub(b1);var bDotDPerp=b.x*d.y-b.y*d.x;if(bDotDPerp==0)return false;var c=
b1.getVecSub(a1);var t=(c.x*d.y-c.y*d.x)/bDotDPerp;if(t<0||t>1)return false;var u=(c.x*b.y-c.y*b.x)/bDotDPerp;if(u<0||u>1)return false;outIntersectionPt=a1.getVecAdd(b.getScalarMult(t));return true}}
class Rect2D{constructor(x,y,w,h){this.x=x||0;this.y=y||0;this.w=w||0;this.h=h||0}static get TOP(){return 0}static get RIGHT(){return 1}static get BOTTOM(){return 2}static get LEFT(){return 3}toString(){return this.x.toFixed(4)+","+this.y.toFixed(4)+":"+this.w.toFixed(4)+"x"+this.h.toFixed(4)}clone(){return new Rect2D(this.x,this.y,this.w,this.h)}getCenter(){return new Vec2D(this.x+this.w/2,this.y+this.h/2)}getVecTL(){return new Vec2D(this.x,this.y)}getVecTR(){return new Vec2D(this.x+this.w,this.y)}getVecBL(){return new Vec2D(this.x,
this.y+this.h)}getVecBR(){return new Vec2D(this.x+this.w,this.y+this.h)}getSpikeTL(){return new Vec2D(-this.w/2,-this.h/2)}getSpikeTR(){return new Vec2D(this.w/2,-this.h/2)}getSpikeBL(){return new Vec2D(-this.w/2,this.h/2)}getSpikeBR(){return new Vec2D(this.w/2,this.h/2)}getSegmentTop(){return Segment2D.SegmentWithValues(this.x,this.y,this.x+this.w,this.y)}getSegmentBottom(){return Segment2D.SegmentWithValues(this.x,this.y+this.h,this.x+this.w,this.y+this.h)}getSegmentLeft(){return Segment2D.SegmentWithValues(this.x,
this.y,this.x,this.y+this.h)}getSegmentRight(){return Segment2D.SegmentWithValues(this.x,this.y+this.h,this.x+this.w,this.y+this.h)}equalsRect(r2d){if(this.x==r2d.x&&this.y==r2d.y&&this.w==r2d.w&&this.h==r2d.h)return true;return false}setRect(r2d){this.x=r2d.x;this.y=r2d.y;this.w=r2d.w;this.h=r2d.h;return this}setSizeVec(v2d){this.w=v2d.x;this.h=v2d.y;return this}setSize(x,y){this.w=x;this.h=y;return this}getSizeVec(){return new Vec2D(this.w,this.h)}setCenter(x,y){this.x=x-this.w/2;this.y=y-this.h/
2;return this}setVecCenter(v2d){this.x=v2d.x-this.w/2;this.y=v2d.y-this.h/2;return this}addVecOffset(v2d){this.x+=v2d.x;this.y+=v2d.y;return this}subVecOffset(v2d){this.x-=v2d.x;this.y-=v2d.y;return this}addOffset(x,y){this.x+=x;this.y+=y;return this}isPointInside(v2d){if(v2d.x<this.x)return false;if(v2d.y<this.y)return false;if(v2d.x>this.x+this.w)return false;if(v2d.y>this.y+this.h)return false;return true}isRectOverlapped(r2d){if(r2d.x>this.x+this.w)return false;if(r2d.y>this.y+this.h)return false;
if(r2d.x+r2d.w<this.x)return false;if(r2d.y+r2d.h<this.y)return false;return true}static isPointInArea(px,py,ax,ay,aw,ah){if(px<ax)return false;if(py<ay)return false;if(px>ax+aw)return false;if(py>ay+ah)return false;return true}static isVecInArea(p,a,s){if(p.x<a.x)return false;if(p.y<a.y)return false;if(p.x>a.x+s.x)return false;if(p.y>a.y+s.y)return false;return true}static getUnion(r1,r2){var r=new Rect2D;r.x=r1.x<r2.x?r1.x:r2.x;r.y=r1.y<r2.y?r1.y:r2.y;var xw1=r1.x+r1.w;var xw2=r2.x+r2.w;r.w=xw1>
xw2?xw1-r.x:xw2-r.x;var yh1=r1.y+r1.h;var yh2=r2.y+r2.h;r.h=yh1>yh2?yh1-r.y:yh2-r.y;return r}static getIntersection(r1,r2){var r=new Rect2D;r.x=r1.x>r2.x?r1.x:r2.x;r.y=r1.y>r2.y?r1.y:r2.y;var xw1=r1.x+r1.w;var xw2=r2.x+r2.w;r.w=xw1<xw2?xw1-r.x:xw2-r.x;var yh1=r1.y+r1.h;var yh2=r2.y+r2.h;r.h=yh1<yh2?yh1-r.y:yh2-r.y;return r}static getInscribedRotatedRect(r,rot){var center=r.getCenter();var spikeTL=r.getSpikeTL().rotate(rot).addVec(center);var spikeTR=r.getSpikeTR().rotate(rot).addVec(center);var spikeBL=
r.getSpikeBL().rotate(rot).addVec(center);var spikeBR=r.getSpikeBR().rotate(rot).addVec(center);var minX=Math.min(spikeTL.x,spikeTR.x,spikeBL.x,spikeBR.x);var maxX=Math.max(spikeTL.x,spikeTR.x,spikeBL.x,spikeBR.x);var minY=Math.min(spikeTL.y,spikeTR.y,spikeBL.y,spikeBR.y);var maxY=Math.max(spikeTL.y,spikeTR.y,spikeBL.y,spikeBR.y);return new Rect2D(minX,minY,maxX-minX,maxY-minY)}static doUnitTest(){console.log("Beginning Rect2D unit tests...");var r1=new Rect2D(0,0,100,100);var r2=new Rect2D(50,50,
100,100);var r3=new Rect2D(-10,-20,10,20);console.log("test unions: ");var u1=Rect2D.getUnion(r1,r2);console.log("expect "+(new Rect2D(0,0,150,150)).toString());console.log("result "+u1.toString());var u2=Rect2D.getUnion(r1,r3);console.log("expect "+(new Rect2D(-10,-20,110,120)).toString());console.log("result "+u2.toString());console.log("test intersects: ");var i1=Rect2D.getIntersection(r1,r2);console.log("expect "+(new Rect2D(50,50,50,50)).toString());console.log("result "+i1.toString());var i2=
Rect2D.getIntersection(r1,r3);console.log("expect "+(new Rect2D(0,0,0,0)).toString());console.log("result "+i2.toString())}};